<script>
    var container = document.querySelector("#unity-container");
    var canvas = document.querySelector("#unity-canvas");
    var loadingCover = document.querySelector("#loading-cover");
    var progressBarFull = document.querySelector("#unity-progress-bar-full");

    var buildUrl = "Build";
    var loaderUrl = buildUrl + "/Telegram.loader.js";
    var config = {
        dataUrl: buildUrl + "/Telegram.data",
        frameworkUrl: buildUrl + "/Telegram.framework.js",
        codeUrl: buildUrl + "/Telegram.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "MccGameMini",
        productVersion: "1.0",
        showBanner: unityShowBanner,
    };

    loadingCover.style.display = "block";

    var script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
            progressBarFull.style.width = 100 * progress + "%";
        }).then((unityInstance) => {
            loadingCover.style.display = "none";

            console.log(Telegram.WebApp.initDataUnsafe);

            const startParam = Telegram.WebApp.initDataUnsafe.start_param || '';
            console.log(startParam);

            if (startParam) {
                const decodedData = atob(startParam);
                const parsedData = JSON.parse(decodedData);
                console.log(parsedData);
                unityInstance.SendMessage('AppManager', 'LinkAccount', parsedData.accountEmail);
            }

            const userData = Telegram.WebApp.initDataUnsafe.user || {};
            console.log(userData);

            // Kiểm tra trạng thái Premium
            const isPremium = userData.photo_url && userData.photo_url.endsWith(".gif");
            console.log("Is Premium:", isPremium);

            const requestDataJson = JSON.stringify({
                avatar: userData.photo_url || "https://via.placeholder.com/150",
                blocked: "ACTIVATE",
                date_of_birth: null,
                first_name: userData.first_name || "Unknown",
                last_name: userData.last_name || "Unknown",
                phone_number: null,
                user_name: userData.username || "Unknown",
                uuid: userData.id || "123456789",
                referral_code: null,
                // is_premium: isPremium 
            });

            if (typeof unityInstance !== 'undefined' && unityInstance.Module) {
                console.log("[Web] Sending login data to Unity:", requestDataJson);
                unityInstance.SendMessage('AppManager', 'ReceiveJsonDataFromWeb', requestDataJson);
            } else {
                console.error("[Web] Unity instance is not ready.");
            }
        }).catch((message) => {
            alert(message);
        });
    };

    document.body.appendChild(script);
</script>
